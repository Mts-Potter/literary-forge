'use client'

import { useState } from 'react'
import { createClient } from '@/lib/supabase/client'
import { processBook, saveChunksToSupabase, BookChunk } from '@/lib/ingest/book-processor'

export function BookIngestionUI() {
  const [file, setFile] = useState<File | null>(null)
  const [title, setTitle] = useState('')
  const [author, setAuthor] = useState('')
  const [isProcessing, setIsProcessing] = useState(false)
  const [progress, setProgress] = useState(0)
  const [statusMessage, setStatusMessage] = useState('')
  const [processedChunks, setProcessedChunks] = useState<BookChunk[]>([])
  const [importResult, setImportResult] = useState<{ success: number; failed: number } | null>(null)

  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    const selectedFile = e.target.files?.[0]
    if (selectedFile && selectedFile.type === 'text/plain') {
      setFile(selectedFile)
      // Auto-fill title from filename
      if (!title) {
        setTitle(selectedFile.name.replace('.txt', ''))
      }
    } else {
      alert('Bitte w√§hle eine .txt Datei')
    }
  }

  const handleProcess = async () => {
    if (!file || !title || !author) {
      alert('Bitte f√ºlle alle Felder aus')
      return
    }

    setIsProcessing(true)
    setProgress(0)
    setStatusMessage('Lese Datei...')
    setProcessedChunks([])
    setImportResult(null)

    try {
      // Datei einlesen
      const text = await file.text()

      // Verarbeiten
      const chunks = await processBook(
        text,
        title,
        author,
        (percent, message) => {
          setProgress(percent)
          setStatusMessage(message)
        }
      )

      setProcessedChunks(chunks)
      setStatusMessage(`‚úÖ ${chunks.length} Chunks erfolgreich verarbeitet!`)
    } catch (error: any) {
      setStatusMessage(`‚ùå Fehler: ${error.message}`)
      console.error(error)
    } finally {
      setIsProcessing(false)
    }
  }

  const handleImport = async () => {
    if (processedChunks.length === 0) {
      alert('Keine Chunks zum Importieren')
      return
    }

    setIsProcessing(true)
    setProgress(0)
    setStatusMessage('Importiere in Datenbank...')

    try {
      const supabase = createClient()

      const result = await saveChunksToSupabase(
        processedChunks,
        supabase,
        (percent, message) => {
          setProgress(percent)
          setStatusMessage(message)
        }
      )

      setImportResult(result)
    } catch (error: any) {
      setStatusMessage(`‚ùå Fehler beim Import: ${error.message}`)
      console.error(error)
    } finally {
      setIsProcessing(false)
    }
  }

  const handleReset = () => {
    setFile(null)
    setTitle('')
    setAuthor('')
    setProgress(0)
    setStatusMessage('')
    setProcessedChunks([])
    setImportResult(null)
  }

  return (
    <div className="max-w-4xl mx-auto p-8">
      <div className="bg-white rounded-lg shadow-lg p-8">
        <h1 className="text-3xl font-bold mb-2 text-gray-900">
          üìö Book Ingestion System
        </h1>
        <p className="text-sm text-gray-600 mb-8">
          Importiert .txt Dateien mit wissenschaftlich konsistenten Metriken (UDPipe + Transformers.js)
        </p>

        {/* Input Form */}
        <div className="space-y-4 mb-8">
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              Textdatei (.txt)
            </label>
            <input
              type="file"
              accept=".txt"
              onChange={handleFileSelect}
              disabled={isProcessing}
              className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg
                         focus:border-blue-500 focus:outline-none
                         disabled:bg-gray-100 disabled:cursor-not-allowed"
            />
            {file && (
              <p className="mt-2 text-sm text-gray-600">
                üìÑ {file.name} ({(file.size / 1024).toFixed(1)} KB)
              </p>
            )}
          </div>

          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              Titel
            </label>
            <input
              type="text"
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              placeholder="z.B. Der Prozess"
              disabled={isProcessing}
              className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg
                         focus:border-blue-500 focus:outline-none
                         disabled:bg-gray-100"
            />
          </div>

          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              Autor
            </label>
            <input
              type="text"
              value={author}
              onChange={(e) => setAuthor(e.target.value)}
              placeholder="z.B. Franz Kafka"
              disabled={isProcessing}
              className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg
                         focus:border-blue-500 focus:outline-none
                         disabled:bg-gray-100"
            />
          </div>
        </div>

        {/* Action Buttons */}
        <div className="flex gap-4 mb-8">
          {processedChunks.length === 0 ? (
            <button
              onClick={handleProcess}
              disabled={isProcessing || !file || !title || !author}
              className="flex-1 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg
                         hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed
                         transition-colors"
            >
              {isProcessing ? '‚è≥ Verarbeite...' : 'üîç Text Analysieren'}
            </button>
          ) : (
            <>
              <button
                onClick={handleImport}
                disabled={isProcessing || importResult !== null}
                className="flex-1 px-6 py-3 bg-green-600 text-white font-semibold rounded-lg
                           hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed
                           transition-colors"
              >
                {isProcessing ? '‚è≥ Importiere...' : 'üíæ In Datenbank Speichern'}
              </button>
              <button
                onClick={handleReset}
                disabled={isProcessing}
                className="px-6 py-3 border-2 border-gray-300 text-gray-700 font-semibold rounded-lg
                           hover:border-gray-400 hover:bg-gray-50 disabled:opacity-50
                           transition-colors"
              >
                üîÑ Neu Starten
              </button>
            </>
          )}
        </div>

        {/* Progress Bar */}
        {isProcessing && (
          <div className="mb-8">
            <div className="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
              <div
                className="bg-blue-600 h-4 transition-all duration-300"
                style={{ width: `${progress}%` }}
              />
            </div>
            <p className="mt-2 text-sm text-gray-700 text-center">{statusMessage}</p>
          </div>
        )}

        {/* Status Message */}
        {!isProcessing && statusMessage && (
          <div className={`p-4 rounded-lg mb-8 ${
            statusMessage.startsWith('‚úÖ') ? 'bg-green-50 text-green-800' :
            statusMessage.startsWith('‚ùå') ? 'bg-red-50 text-red-800' :
            'bg-blue-50 text-blue-800'
          }`}>
            {statusMessage}
          </div>
        )}

        {/* Chunks Preview */}
        {processedChunks.length > 0 && !importResult && (
          <div className="border-2 border-gray-200 rounded-lg p-6">
            <h2 className="text-xl font-semibold mb-4 text-gray-900">
              üìä Verarbeitete Chunks ({processedChunks.length})
            </h2>
            <div className="space-y-4 max-h-96 overflow-y-auto">
              {processedChunks.slice(0, 5).map((chunk, idx) => (
                <div key={idx} className="bg-gray-50 p-4 rounded-lg text-sm">
                  <div className="font-semibold text-gray-900 mb-2">
                    {chunk.title} ‚Ä¢ Level {chunk.difficulty_level}/5
                  </div>
                  <div className="text-gray-700 mb-2 line-clamp-3">
                    {chunk.content}
                  </div>
                  <div className="flex gap-4 text-xs text-gray-600">
                    <span>DD: {chunk.metrics.dependencyDistance.toFixed(2)}</span>
                    <span>A/V: {chunk.metrics.adjVerbRatio.toFixed(2)}</span>
                    <span>œÉ: {chunk.metrics.sentenceLengthVariance.toFixed(2)}</span>
                  </div>
                </div>
              ))}
              {processedChunks.length > 5 && (
                <p className="text-sm text-gray-600 text-center">
                  ... und {processedChunks.length - 5} weitere Chunks
                </p>
              )}
            </div>
          </div>
        )}

        {/* Import Result */}
        {importResult && (
          <div className="border-2 border-green-500 bg-green-50 rounded-lg p-6">
            <h2 className="text-xl font-semibold mb-4 text-green-900">
              ‚úÖ Import Abgeschlossen
            </h2>
            <div className="space-y-2 text-green-800">
              <p className="text-lg">
                <strong>{importResult.success}</strong> Chunks erfolgreich importiert
              </p>
              {importResult.failed > 0 && (
                <p className="text-orange-700">
                  <strong>{importResult.failed}</strong> Chunks fehlgeschlagen
                </p>
              )}
            </div>
          </div>
        )}
      </div>

      {/* Technical Info */}
      <div className="mt-8 p-6 bg-gray-800 text-gray-300 rounded-lg text-sm">
        <h3 className="font-semibold mb-2 text-white">üî¨ Technische Details</h3>
        <ul className="space-y-1 list-disc list-inside">
          <li>Parser: UDPipe (WASM) f√ºr syntaktische Analyse</li>
          <li>Embeddings: Transformers.js (Xenova/all-MiniLM-L6-v2, ONNX)</li>
          <li>Metriken: Dependency Distance, Adj/Verb Ratio, Sentence Variance</li>
          <li>Chunking: 3-10 S√§tze pro Lerneinheit</li>
          <li>Schwierigkeitsgrad: Automatisch berechnet (1-5)</li>
        </ul>
        <p className="mt-4 text-yellow-400 text-xs">
          ‚ö†Ô∏è Die Verarbeitung l√§uft komplett im Browser. Bei gro√üen B√ºchern kann dies einige Minuten dauern.
        </p>
      </div>
    </div>
  )
}
